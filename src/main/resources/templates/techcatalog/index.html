<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/head :: head('Loja de Eletrônicos')"></head>

  <body class="bg-light">
    <!-- Navbar -->
    <nav th:replace="fragments/navbar :: navbar('listagem')"></nav>

    <div class="container">
      <!-- Header Section -->
      <div class="row mb-4">
        <div class="col-12">
          <!-- Header para User -->
          <div sec:authorize="hasAuthority('user')" class="hero-section">
            <h1 class="hero-title">
              <i class="fas fa-shopping-bag mr-3"></i>Loja de Eletrônicos
            </h1>
            <p class="hero-subtitle">
              Descubra os melhores produtos com preços incríveis
            </p>
          </div>

          <!-- Header para Admin -->
          <div sec:authorize="hasAuthority('Admin')" class="admin-header">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h2 class="mb-1">
                  <i class="fas fa-cogs mr-2 text-primary"></i>Painel
                  Administrativo
                </h2>
                <p class="text-muted mb-0">
                  Gerenciamento de Produtos - Catálogo Eletrônicos
                </p>
              </div>
              <div>
                <a href="/techcatalog/add" class="btn btn-primary">
                  <i class="fas fa-plus mr-1"></i>Novo Produto
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros e Busca -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="fas fa-search"></i>
                  </span>
                </div>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Buscar produtos..."
                  id="searchInput"
                />
              </div>
            </div>
            <div class="col-md-4 mt-2 mt-md-0">
              <select class="form-control" id="categoryFilter">
                <option value="">Todas as categorias</option>
                <option value="smartphone">Smartphones</option>
                <option value="notebook">Notebooks</option>
                <option value="tablet">Tablets</option>
                <option value="acessorio">Acessórios</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Grid de Produtos para USER -->
      <div
        sec:authorize="hasAuthority('user')"
        class="row"
        id="userProductGrid"
      >
        <div
          class="col-lg-4 col-md-6 mb-4"
          th:each="produto : ${eletronicosList}"
        >
          <div class="product-card">
            <!-- Badge de Categoria -->
            <div class="category-badge" th:text="${produto.categoria}"></div>

            <!-- Badge de Estoque -->
            <div class="stock-badge" th:if="${produto.nivelEstoque <= 5}">
              <i class="fas fa-exclamation-triangle"></i> Últimas unidades
            </div>

            <!-- Imagem do Produto -->
            <div class="product-image-container">
              <div
                th:if="${produto.imagemUrl != null and !#strings.isEmpty(produto.imagemUrl)}"
              >
                <img
                  th:src="${produto.imagemUrl}"
                  th:alt="${produto.titulo}"
                  class="product-image"
                  data-toggle="modal"
                  th:data-target="${'#imagemModal-' + produto.id}"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <div class="no-image-placeholder" style="display: none">
                  <i class="fas fa-image fa-3x"></i>
                  <p class="mt-2">Sem imagem</p>
                </div>
              </div>
              <div
                th:unless="${produto.imagemUrl != null and !#strings.isEmpty(produto.imagemUrl)}"
                class="no-image-placeholder"
              >
                <i class="fas fa-image fa-3x"></i>
                <p class="mt-2">Sem imagem</p>
              </div>
            </div>

            <!-- Informações do Produto -->
            <div class="product-info">
              <h5 class="product-title" th:text="${produto.titulo}"></h5>

              <!-- Preço -->
              <div class="price-section">
                <span
                  class="current-price"
                  th:text="${'R$ ' + #numbers.formatDecimal(produto.valorBase, 1, 'POINT', 2, 'COMMA')}"
                ></span>
                <small class="price-installments">ou 12x sem juros</small>
              </div>

              <!-- Estoque -->
              <div class="stock-info">
                <i class="fas fa-box mr-1"></i>
                <span th:text="${produto.nivelEstoque}"></span>
                <small class="text-muted"> em estoque</small>
              </div>

              <!-- Recursos principais (resumo) -->
              <div
                class="product-features"
                th:if="${produto.recursosAdicionais != null and !#strings.isEmpty(produto.recursosAdicionais)}"
              >
                <small
                  class="text-muted"
                  th:text="${#strings.abbreviate(produto.recursosAdicionais, 60)}"
                ></small>
              </div>
            </div>

            <!-- Ações do Produto -->
            <div class="product-actions">
              <!-- Botão Adicionar ao Carrinho -->
              <button
                type="button"
                class="btn btn-primary btn-add-carrinho"
                th:data-produto-id="${produto.id}"
                th:disabled="${produto.nivelEstoque <= 0}"
              >
                <i class="fas fa-shopping-cart mr-1"></i>
                <span th:if="${produto.nivelEstoque > 0}"
                  >Adicionar ao Carrinho</span
                >
                <span th:if="${produto.nivelEstoque <= 0}">Indisponível</span>
              </button>

              <!-- Botão de Detalhes -->
              <button
                type="button"
                class="btn btn-outline-info btn-details"
                data-toggle="modal"
                th:data-target="${'#detalhesModal-' + produto.id}"
              >
                <i class="fas fa-eye mr-1"></i>Ver Detalhes
              </button>
            </div>
          </div>
        </div>

        <!-- Mensagem quando não há produtos -->
        <div class="col-12" th:if="${#lists.isEmpty(eletronicosList)}">
          <div class="empty-state">
            <i class="fas fa-shopping-bag fa-4x mb-3"></i>
            <h3>Nenhum produto encontrado</h3>
            <p class="text-muted">Não há produtos cadastrados no momento.</p>
          </div>
        </div>
      </div>

      <!-- Tabela de Produtos para ADMIN -->
      <div sec:authorize="hasAuthority('Admin')" class="admin-product-table">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fas fa-table mr-2"></i>Produtos Cadastrados
              <span
                class="badge badge-light ml-2"
                th:text="${#lists.size(eletronicosList)}"
              ></span>
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="thead-light">
                  <tr>
                    <th width="60">ID</th>
                    <th width="80">Imagem</th>
                    <th>Produto</th>
                    <th width="120">Categoria</th>
                    <th width="120">Preço</th>
                    <th width="80">Estoque</th>
                    <th width="120">Status</th>
                    <th width="200">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="produto : ${eletronicosList}">
                    <td>
                      <span
                        class="badge badge-secondary"
                        th:text="${produto.id}"
                      ></span>
                    </td>
                    <td>
                      <div class="admin-product-image">
                        <img
                          th:if="${produto.imagemUrl != null and !#strings.isEmpty(produto.imagemUrl)}"
                          th:src="${produto.imagemUrl}"
                          th:alt="${produto.titulo}"
                          class="img-thumbnail"
                          style="width: 50px; height: 50px; object-fit: cover"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <div
                          class="no-image-small"
                          style="
                            display: none;
                            width: 50px;
                            height: 50px;
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                        >
                          <i class="fas fa-image text-muted"></i>
                        </div>
                        <div
                          th:unless="${produto.imagemUrl != null and !#strings.isEmpty(produto.imagemUrl)}"
                          class="no-image-small"
                          style="
                            width: 50px;
                            height: 50px;
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                        >
                          <i class="fas fa-image text-muted"></i>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div>
                        <strong th:text="${produto.titulo}"></strong>
                        <br />
                        <small
                          class="text-muted"
                          th:text="${#strings.abbreviate(produto.recursosAdicionais, 50)}"
                        ></small>
                      </div>
                    </td>
                    <td>
                      <span
                        class="badge badge-info"
                        th:text="${produto.categoria}"
                      ></span>
                    </td>
                    <td>
                      <strong
                        class="text-success"
                        th:text="${'R$ ' + #numbers.formatDecimal(produto.valorBase, 1, 'POINT', 2, 'COMMA')}"
                      ></strong>
                    </td>
                    <td>
                      <span
                        class="badge badge-primary"
                        th:text="${produto.nivelEstoque}"
                      ></span>
                    </td>
                    <td>
                      <span
                        class="badge badge-success"
                        th:if="${produto.nivelEstoque > 10}"
                      >
                        <i class="fas fa-check"></i> Disponível
                      </span>
                      <span
                        class="badge badge-warning"
                        th:if="${produto.nivelEstoque <= 10 and produto.nivelEstoque > 0}"
                      >
                        <i class="fas fa-exclamation-triangle"></i> Baixo
                      </span>
                      <span
                        class="badge badge-danger"
                        th:if="${produto.nivelEstoque <= 0}"
                      >
                        <i class="fas fa-times"></i> Esgotado
                      </span>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button
                          type="button"
                          class="btn btn-outline-info"
                          data-toggle="modal"
                          th:data-target="${'#detalhesModal-' + produto.id}"
                          title="Ver Detalhes"
                        >
                          <i class="fas fa-eye"></i>
                        </button>
                        <a
                          th:href="@{/techcatalog/edit/{id}(id=${produto.id})}"
                          class="btn btn-outline-warning"
                          title="Editar Produto"
                        >
                          <i class="fas fa-edit"></i>
                        </a>
                        <a
                          th:href="@{/techcatalog/delete/{id}(id=${produto.id})}"
                          class="btn btn-outline-danger"
                          title="Excluir Produto"
                          onclick="return confirm('Tem certeza que deseja excluir este produto?')"
                        >
                          <i class="fas fa-trash"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Mensagem quando não há produtos (Admin) -->
        <div
          class="text-center py-5"
          th:if="${#lists.isEmpty(eletronicosList)}"
        >
          <i class="fas fa-database fa-4x text-muted mb-3"></i>
          <h3 class="text-muted">Nenhum produto cadastrado</h3>
          <p class="text-muted">
            Comece adicionando seu primeiro produto ao catálogo.
          </p>
          <a href="/techcatalog/add" class="btn btn-primary">
            <i class="fas fa-plus mr-1"></i>Adicionar Produto
          </a>
        </div>
      </div>

      <!-- Paginação (se necessário) -->
      <nav aria-label="Navegação de páginas" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1">Anterior</a>
          </li>
          <li class="page-item active">
            <a class="page-link" href="#">1</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#">2</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#">3</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#">Próximo</a>
          </li>
        </ul>
      </nav>
    </div>

    <!-- Modal de Carrinho -->
    <div class="modal fade" id="cartModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="fas fa-check-circle mr-2"></i>Produto Adicionado ao
              Carrinho!
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <i class="fas fa-shopping-cart fa-3x text-success mb-3"></i>
            <h6 id="cartProductName">Produto</h6>
            <p>foi adicionado ao seu carrinho com sucesso!</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Continuar Comprando
            </button>
            <a href="/carrinho" class="btn btn-success">
              <i class="fas fa-shopping-cart mr-1"></i>Ver Carrinho
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Modais de Imagem -->
    <div
      th:each="produto : ${eletronicosList}"
      th:if="${produto.imagemUrl != null and !#strings.isEmpty(produto.imagemUrl)}"
      th:id="${'imagemModal-' + produto.id}"
      class="modal fade"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" th:text="${produto.titulo}"></h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <img
              th:src="${produto.imagemUrl}"
              th:alt="${produto.titulo}"
              class="img-fluid rounded"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Modais de Detalhes -->
    <div
      th:each="produto : ${eletronicosList}"
      th:id="${'detalhesModal-' + produto.id}"
      class="modal fade"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-info-circle mr-2"></i>Detalhes do Produto
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- Imagem do Produto -->
              <div class="col-md-5">
                <div
                  th:if="${produto.imagemUrl != null and !#strings.isEmpty(produto.imagemUrl)}"
                >
                  <img
                    th:src="${produto.imagemUrl}"
                    th:alt="${produto.titulo}"
                    class="img-fluid rounded shadow"
                  />
                </div>
                <div
                  th:unless="${produto.imagemUrl != null and !#strings.isEmpty(produto.imagemUrl)}"
                  class="no-image-large"
                >
                  <i class="fas fa-image fa-4x"></i>
                  <p class="mt-3">Imagem não disponível</p>
                </div>
              </div>

              <!-- Informações do Produto -->
              <div class="col-md-7">
                <h3 th:text="${produto.titulo}"></h3>
                <p class="text-muted mb-3" th:text="${produto.categoria}"></p>

                <!-- Preço Destacado -->
                <div class="price-highlight">
                  <h2
                    class="text-primary"
                    th:text="${'R$ ' + #numbers.formatDecimal(produto.valorBase, 1, 'POINT', 2, 'COMMA')}"
                  ></h2>
                  <small class="text-muted"
                    >ou 12x de R$ [[${#numbers.formatDecimal(produto.valorBase /
                    12, 1, 'POINT', 2, 'COMMA')}]] sem juros</small
                  >
                </div>

                <!-- Estoque -->
                <div class="stock-status mb-3">
                  <span
                    class="badge badge-success"
                    th:if="${produto.nivelEstoque > 10}"
                  >
                    <i class="fas fa-check mr-1"></i>Em estoque
                    ([[${produto.nivelEstoque}]] unidades)
                  </span>
                  <span
                    class="badge badge-warning"
                    th:if="${produto.nivelEstoque <= 10 and produto.nivelEstoque > 0}"
                  >
                    <i class="fas fa-exclamation-triangle mr-1"></i>Últimas
                    [[${produto.nivelEstoque}]] unidades
                  </span>
                  <span
                    class="badge badge-danger"
                    th:if="${produto.nivelEstoque <= 0}"
                  >
                    <i class="fas fa-times mr-1"></i>Indisponível
                  </span>
                </div>

                <!-- Recursos Principais -->
                <div
                  class="features-section mb-4"
                  th:if="${produto.recursosAdicionais != null and !#strings.isEmpty(produto.recursosAdicionais)}"
                >
                  <h6>
                    <i class="fas fa-star text-warning mr-1"></i>Recursos
                    Principais
                  </h6>
                  <p th:text="${produto.recursosAdicionais}"></p>
                </div>

                <!-- Locais Disponíveis -->
                <div
                  class="locations-section mb-4"
                  th:if="${produto.locaisDisponiveis != null and !#strings.isEmpty(produto.locaisDisponiveis)}"
                >
                  <h6>
                    <i class="fas fa-map-marker-alt text-info mr-1"></i
                    >Disponível em
                  </h6>
                  <p th:text="${produto.locaisDisponiveis}"></p>
                </div>

                <!-- Ações -->
                <div class="product-actions-modal">
                  <button
                    sec:authorize="hasAuthority('user')"
                    type="button"
                    class="btn btn-success btn-lg btn-add-carrinho"
                    th:data-produto-id="${produto.id}"
                    th:disabled="${produto.nivelEstoque <= 0}"
                  >
                    <i class="fas fa-shopping-cart mr-2"></i>
                    <span th:if="${produto.nivelEstoque > 0}"
                      >Adicionar ao Carrinho</span
                    >
                    <span th:if="${produto.nivelEstoque <= 0}"
                      >Produto Indisponível</span
                    >
                  </button>

                  <div
                    sec:authorize="hasAuthority('Admin')"
                    class="admin-actions-modal"
                  >
                    <div class="btn-group" role="group">
                      <a
                        th:href="@{/techcatalog/edit/{id}(id=${produto.id})}"
                        class="btn btn-warning btn-lg"
                      >
                        <i class="fas fa-edit mr-1"></i>Editar Produto
                      </a>
                      <a
                        th:href="@{/techcatalog/delete/{id}(id=${produto.id})}"
                        class="btn btn-danger btn-lg"
                        onclick="return confirm('Tem certeza que deseja excluir este produto?')"
                      >
                        <i class="fas fa-trash mr-1"></i>Excluir Produto
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Especificações Técnicas -->
            <div class="row mt-4">
              <div class="col-12">
                <ul
                  class="nav nav-tabs"
                  th:id="${'productTabs-' + produto.id}"
                  role="tablist"
                >
                  <li class="nav-item" role="presentation">
                    <a
                      class="nav-link active"
                      th:id="${'specs-tab-' + produto.id}"
                      data-toggle="tab"
                      th:href="${'#specs-' + produto.id}"
                      role="tab"
                      th:aria-controls="${'specs-' + produto.id}"
                      aria-selected="true"
                    >
                      <i class="fas fa-cogs mr-1"></i>Especificações
                    </a>
                  </li>
                  <li
                    class="nav-item"
                    role="presentation"
                    th:if="${produto.descricaoProduto != null and !#strings.isEmpty(produto.descricaoProduto)}"
                  >
                    <a
                      class="nav-link"
                      th:id="${'description-tab-' + produto.id}"
                      data-toggle="tab"
                      th:href="${'#description-' + produto.id}"
                      role="tab"
                      th:aria-controls="${'description-' + produto.id}"
                      aria-selected="false"
                    >
                      <i class="fas fa-align-left mr-1"></i>Descrição
                    </a>
                  </li>
                </ul>
                <div
                  class="tab-content"
                  th:id="${'productTabsContent-' + produto.id}"
                >
                  <div
                    class="tab-pane fade show active"
                    th:id="${'specs-' + produto.id}"
                    role="tabpanel"
                    th:aria-labelledby="${'specs-tab-' + produto.id}"
                  >
                    <div class="specs-content">
                      <p th:text="${produto.especificacaoTecnica}"></p>
                    </div>
                  </div>
                  <div
                    class="tab-pane fade"
                    th:id="${'description-' + produto.id}"
                    role="tabpanel"
                    th:aria-labelledby="${'description-tab-' + produto.id}"
                    th:if="${produto.descricaoProduto != null and !#strings.isEmpty(produto.descricaoProduto)}"
                  >
                    <div class="description-content">
                      <p th:text="${produto.descricaoProduto}"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              <i class="fas fa-times mr-1"></i>Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <div th:replace="fragments/head :: scripts"></div>

    <script>
      // Funcionalidade de filtros e busca
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("searchInput");
        const categoryFilter = document.getElementById("categoryFilter");

        // Função para filtrar produtos
        function filterProducts() {
          const searchTerm = searchInput.value.toLowerCase();
          const selectedCategory = categoryFilter.value.toLowerCase();

          // Seletor corrigido para produtos de usuário
          const productCards = document.querySelectorAll(
            "#userProductGrid .col-lg-4.col-md-6.mb-4"
          );

          // Seletor para linhas da tabela admin
          const adminRows = document.querySelectorAll(
            ".admin-product-table tbody tr"
          );

          // Filtrar cards de produtos (view de usuário)
          productCards.forEach((card) => {
            const titleElement = card.querySelector(".product-title");
            const categoryElement = card.querySelector(".category-badge");

            if (titleElement && categoryElement) {
              const title = titleElement.textContent.toLowerCase();
              const category = categoryElement.textContent.toLowerCase();

              const matchesSearch = title.includes(searchTerm);
              const matchesCategory =
                selectedCategory === "" || category.includes(selectedCategory);

              card.style.display =
                matchesSearch && matchesCategory ? "block" : "none";
            }
          });

          // Filtrar tabela admin
          adminRows.forEach((row) => {
            const titleElement = row.querySelector("td:nth-child(3) strong");
            const categoryElement = row.querySelector("td:nth-child(4) .badge");

            if (titleElement && categoryElement) {
              const title = titleElement.textContent.toLowerCase();
              const category = categoryElement.textContent.toLowerCase();

              const matchesSearch = title.includes(searchTerm);
              const matchesCategory =
                selectedCategory === "" || category.includes(selectedCategory);

              row.style.display =
                matchesSearch && matchesCategory ? "" : "none";
            }
          });
        }

        // Event listeners para filtros
        if (searchInput) {
          searchInput.addEventListener("input", filterProducts);
        }

        if (categoryFilter) {
          categoryFilter.addEventListener("change", filterProducts);
        }
      });

      /**
       * Utilitários JavaScript para funcionalidades do carrinho - COM SUPORTE A CSRF
       */

      class CarrinhoUtils {
        constructor() {
          this.csrfToken = this.getCsrfToken();
          this.initEventListeners();
          this.updateNavbarCarrinho();
          this.testConnection();
        }

        /**
         * Obtém o token CSRF da página
         */
        getCsrfToken() {
          let token = $('meta[name="_csrf"]').attr("content");
          if (!token) {
            token = $('input[name="_csrf"]').val();
          }
          console.log(
            "🔒 CSRF Token:",
            token ? "encontrado" : "não encontrado"
          );
          return token;
        }

        /**
         * Testa a conexão com o backend
         */
        testConnection() {
          console.log("🔄 Testando conexão com o backend...");

          // Teste GET
          $.ajax({
            url: "/carrinho/test",
            method: "GET",
            timeout: 5000,
            success: (response) => {
              console.log("✅ Teste GET funcionou:", response);
            },
            error: (xhr, status, error) => {
              console.error("❌ Erro no teste GET:", {
                status: xhr.status,
                statusText: xhr.statusText,
                error: error,
                responseText: xhr.responseText,
              });
            },
          });

          // Teste POST com CSRF
          const postData = { param: "teste" };
          if (this.csrfToken) {
            postData._csrf = this.csrfToken;
          }

          $.ajax({
            url: "/carrinho/test-post",
            method: "POST",
            data: postData,
            timeout: 5000,
            beforeSend: (xhr) => {
              if (this.csrfToken) {
                xhr.setRequestHeader("X-CSRF-TOKEN", this.csrfToken);
              }
            },
            success: (response) => {
              console.log("✅ Teste POST funcionou:", response);
            },
            error: (xhr, status, error) => {
              console.error("❌ Erro no teste POST:", {
                status: xhr.status,
                statusText: xhr.statusText,
                error: error,
                responseText: xhr.responseText,
              });
            },
          });
        }

        /**
         * Inicializa os event listeners
         */
        initEventListeners() {
          // Event listener para botões de adicionar ao carrinho
          $(document).on("click", ".btn-add-carrinho", (e) => {
            e.preventDefault();
            const button = $(e.currentTarget);
            const produtoId = button.data("produto-id");
            const quantidade = button.data("quantidade") || 1;

            console.log("🛒 Clique no botão adicionar carrinho:", {
              produtoId,
              quantidade,
            });
            this.adicionarProduto(produtoId, quantidade, button);
          });

          // Event listener para formulários de adicionar ao carrinho
          $(document).on("submit", ".form-add-carrinho", (e) => {
            e.preventDefault();
            const form = $(e.currentTarget);
            const produtoId = form.find('input[name="produtoId"]').val();
            const quantidade = form.find('input[name="quantidade"]').val() || 1;

            console.log("📝 Submit do formulário carrinho:", {
              produtoId,
              quantidade,
            });
            this.adicionarProduto(produtoId, quantidade);
          });

          // Atualizar contador do carrinho periodicamente
          setInterval(() => {
            this.updateNavbarCarrinho();
          }, 30000); // A cada 30 segundos
        }

        /**
         * Adiciona produto ao carrinho com CSRF
         */
        adicionarProduto(produtoId, quantidade = 1, button = null) {
          console.log("🚀 Iniciando adição de produto:", {
            produtoId: produtoId,
            quantidade: quantidade,
            tipo: typeof produtoId,
            button: button ? "presente" : "ausente",
          });

          // Validação básica
          if (!produtoId || produtoId === "" || produtoId === "undefined") {
            console.error("❌ ID do produto inválido:", produtoId);
            this.showNotification(
              "error",
              "Erro: ID do produto não encontrado"
            );
            return;
          }

          // Mostrar loading no botão se fornecido
          if (button) {
            const originalText = button.html();
            button
              .prop("disabled", true)
              .html('<i class="fas fa-spinner fa-spin"></i> Adicionando...');

            // Restaurar botão após operação
            setTimeout(() => {
              button.prop("disabled", false).html(originalText);
            }, 3000);
          }

          // Preparar dados com CSRF
          const requestData = {
            produtoId: parseInt(produtoId),
            quantidade: parseInt(quantidade),
          };

          if (this.csrfToken) {
            requestData._csrf = this.csrfToken;
          }

          console.log("📤 Enviando dados:", requestData);

          // Tentar múltiplas abordagens
          this.tryAddToCart(requestData, 0);
        }

        /**
         * Tenta adicionar ao carrinho com diferentes métodos
         */
        tryAddToCart(requestData, attempt = 0) {
          const methods = [
            // Método 1: Form data tradicional
            {
              name: "Form Data",
              config: {
                url: "/carrinho/adicionar",
                method: "POST",
                data: requestData,
                dataType: "json",
                timeout: 10000,
                beforeSend: (xhr) => {
                  xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                  if (this.csrfToken) {
                    xhr.setRequestHeader("X-CSRF-TOKEN", this.csrfToken);
                  }
                },
              },
            },
            // Método 2: JSON
            {
              name: "JSON",
              config: {
                url: "/carrinho/adicionar-json",
                method: "POST",
                data: JSON.stringify({
                  produtoId: requestData.produtoId,
                  quantidade: requestData.quantidade,
                }),
                contentType: "application/json",
                dataType: "json",
                timeout: 10000,
                beforeSend: (xhr) => {
                  xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                  if (this.csrfToken) {
                    xhr.setRequestHeader("X-CSRF-TOKEN", this.csrfToken);
                  }
                },
              },
            },
            // Método 3: FormData
            {
              name: "FormData",
              config: {
                url: "/carrinho/adicionar",
                method: "POST",
                data: $.param(requestData),
                contentType: "application/x-www-form-urlencoded",
                dataType: "json",
                timeout: 10000,
                beforeSend: (xhr) => {
                  if (this.csrfToken) {
                    xhr.setRequestHeader("X-CSRF-TOKEN", this.csrfToken);
                  }
                },
              },
            },
          ];

          if (attempt >= methods.length) {
            console.error("❌ Todas as tentativas falharam");
            this.showNotification(
              "error",
              "Erro: Não foi possível adicionar o produto ao carrinho"
            );
            return;
          }

          const method = methods[attempt];
          console.log(`🔄 Tentativa ${attempt + 1}: ${method.name}`);

          $.ajax(method.config)
            .done((response) => {
              console.log(`✅ Sucesso com ${method.name}:`, response);

              if (response.success) {
                this.showNotification("success", response.message);
                this.updateNavbarCarrinho(response.carrinhoResumo);
                this.animateCarrinhoIcon();
              } else {
                this.showNotification("error", response.message);
              }
            })
            .fail((xhr, status, error) => {
              console.error(`❌ Falha com ${method.name}:`, {
                status: xhr.status,
                statusText: xhr.statusText,
                error: error,
                responseText: xhr.responseText,
                headers: xhr.getAllResponseHeaders(),
              });

              if (xhr.status === 401) {
                this.showNotification(
                  "warning",
                  "Você precisa estar logado para adicionar produtos ao carrinho"
                );
                setTimeout(() => {
                  window.location.href = "/login";
                }, 2000);
                return;
              }

              if (xhr.status === 403) {
                this.showNotification(
                  "error",
                  "Erro de permissão. Tente recarregar a página."
                );
                setTimeout(() => {
                  window.location.reload();
                }, 2000);
                return;
              }

              if (xhr.status === 405) {
                console.log(
                  `⚠️ Método não permitido com ${method.name}, tentando próximo...`
                );
                this.tryAddToCart(requestData, attempt + 1);
                return;
              }

              // Se não foi erro 405, tentar próximo método
              if (attempt < methods.length - 1) {
                console.log(`⚠️ Tentando próximo método após falha...`);
                this.tryAddToCart(requestData, attempt + 1);
              } else {
                const response = xhr.responseJSON;
                this.showNotification(
                  "error",
                  response
                    ? response.message
                    : "Erro ao adicionar produto ao carrinho"
                );
              }
            });
        }

        /**
         * Atualiza o contador do carrinho na navbar
         */
        updateNavbarCarrinho(resumo = null) {
          if (resumo) {
            this.updateCarrinhoDisplay(resumo);
          } else {
            // Buscar resumo atual
            $.ajax({
              url: "/carrinho/resumo",
              method: "GET",
              timeout: 5000,
              success: (resumo) => {
                this.updateCarrinhoDisplay(resumo);
              },
              error: (xhr) => {
                if (xhr.status !== 401) {
                  console.warn(
                    "Erro ao buscar resumo do carrinho:",
                    xhr.status
                  );
                }
              },
            });
          }
        }

        /**
         * Atualiza a exibição do carrinho na navbar
         */
        updateCarrinhoDisplay(resumo) {
          const carrinhoIcon = $("#carrinho-icon");
          const carrinhoCount = $("#carrinho-count");
          const carrinhoTotal = $("#carrinho-total");

          console.log("🔄 Atualizando display do carrinho:", resumo);

          if (resumo.totalItens > 0) {
            carrinhoCount.text(resumo.totalItens).show();
            if (carrinhoTotal.length) {
              carrinhoTotal.text("R$ " + this.formatCurrency(resumo.total));
            }
          } else {
            carrinhoCount.hide();
            if (carrinhoTotal.length) {
              carrinhoTotal.text("R$ 0,00");
            }
          }
        }

        /**
         * Anima o ícone do carrinho quando um produto é adicionado
         */
        animateCarrinhoIcon() {
          const carrinhoIcon = $("#carrinho-icon");
          carrinhoIcon.addClass("animate__animated animate__bounce");

          setTimeout(() => {
            carrinhoIcon.removeClass("animate__animated animate__bounce");
          }, 1000);
        }

        /**
         * Exibe notificações toast
         */
        showNotification(type, message) {
          console.log(`📢 Notificação ${type}:`, message);

          const toastTypes = {
            success: { icon: "check-circle", class: "bg-success" },
            error: { icon: "exclamation-circle", class: "bg-danger" },
            warning: { icon: "exclamation-triangle", class: "bg-warning" },
            info: { icon: "info-circle", class: "bg-info" },
          };

          const toast = toastTypes[type] || toastTypes.info;

          // Remover toast anterior se existir
          $(".custom-toast").remove();

          const toastHtml = `
                <div class="custom-toast position-fixed" style="top: 20px; right: 20px; z-index: 9999; max-width: 350px;">
                    <div class="toast show ${toast.class} text-white">
                        <div class="toast-body d-flex align-items-center">
                            <i class="fas fa-${toast.icon} mr-2"></i>
                            <span class="flex-grow-1">${message}</span>
                            <button type="button" class="ml-2 mb-1 close text-white" onclick="$(this).closest('.custom-toast').remove()">
                                <span>&times;</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

          $("body").append(toastHtml);

          // Auto-remover após 5 segundos
          setTimeout(() => {
            $(".custom-toast").fadeOut(() => {
              $(".custom-toast").remove();
            });
          }, 5000);
        }

        /**
         * Formata valor monetário
         */
        formatCurrency(value) {
          return parseFloat(value).toFixed(2).replace(".", ",");
        }

        /**
         * Debug info
         */
        getDebugInfo() {
          return {
            jquery: typeof $ !== "undefined" ? $.fn.jquery : "não carregado",
            url: window.location.href,
            csrf: this.csrfToken ? "presente" : "ausente",
            userAgent: navigator.userAgent,
          };
        }
      }

      // Inicializar quando o documento estiver pronto
      $(document).ready(() => {
        console.log("🚀 Inicializando CarrinhoUtils...");
        const utils = new CarrinhoUtils();
        console.log("Debug info:", utils.getDebugInfo());
        window.carrinhoUtils = utils;
      });

      // Funções globais para compatibilidade
      function adicionarAoCarrinho(produtoId, quantidade = 1, button = null) {
        console.log("🔄 Função global adicionarAoCarrinho chamada:", {
          produtoId,
          quantidade,
        });
        if (window.carrinhoUtils) {
          window.carrinhoUtils.adicionarProduto(produtoId, quantidade, button);
        } else {
          console.error("❌ CarrinhoUtils não inicializado");
        }
      }
    </script>
  </body>
</html>
